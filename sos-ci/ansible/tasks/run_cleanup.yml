- hosts: devstack_instances
  tasks:

  - name: send over upload script
    sudo: no
    template: src=../../scripts/upload_logs.sh dest=/home/ubuntu/

  - name: run upload
    sudo: yes
    shell: bash ./upload_logs.sh {{ instance_name }}
    args:
      chdir: /home/ubuntu

  - name: fetch tempest_results
    sudo: yes
    fetch: src=/opt/stack/tempest/console.log.out dest=../../logs/{{ instance_name }}.console flat=yes validate_md5=no

  - name: fetch logs
    sudo: yes
    fetch: src=/home/ubuntu/{{ instance_name }}.tar.gz dest=../../logs/ flat=yes validate_md5=no

- hosts: localhost
  connection: local
  tasks:
  - name: Shut down instance
    nova_compute:
      state: absent
      login_username: "{{ os_login }}"
      login_password: "{{ os_password }}"
      login_tenant_name: "{{ os_tenant_name }}"
      auth_url: "{{ auth_url }}"
      name: "{{ instance_name }}"
